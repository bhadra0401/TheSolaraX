<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Payments | zeBRO</title>
    <script src="https://cdn.jsdelivr.net/npm/qrcode-generator"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>

<header>
    <div class="logo">zeBRO</div>
    <nav>
        <a href="homepage.html">Home</a>
        <a href="plans.html">Services</a>
        <a href="#" id="logoutBtn">Logout</a>
    </nav>
</header>

<h1>Make a Payment</h1>
<div class="payment-options">
    <button onclick="generateQRCode(1599)">Pay ₹1599</button>
    <button onclick="generateQRCode(599)">Pay ₹599</button>
    <button onclick="generateQRCode(2199)">Pay ₹2199</button>
</div>

<div id="qr-code-container" style="display: none; text-align: center;">
    <h3>Scan the QR Code to Pay</h3>
    <div id="qrcode"></div>
    <p>After payment, submit your proof below.</p>
</div>

<div id="payment-proof-form" style="display: none;">
    <h2>Submit Payment Proof</h2>
    <input type="text" id="codetantra-id" placeholder="Enter Codetantra ID" required>
    <input type="password" id="codetantra-password" placeholder="Enter Codetantra Password" required>
    <input type="text" id="payment-id" placeholder="Enter Payment ID" required>
    <input type="file" id="screenshot" accept="image/*" required>
    <button onclick="submitPaymentProof()">Submit Proof</button>
</div>

<h2>Your Payment Status</h2>
<div id="payment-list">Fetching payment details...</div>

<script>
    const backendUrl = "https://thesolarax.onrender.com";

    document.addEventListener("DOMContentLoaded", function () {
        const token = localStorage.getItem("token");
        if (!token) {
            alert("Please log in first.");
            window.location.href = "index.html";
            return;
        }
        fetchPayments();
    });

    let selectedAmount = localStorage.getItem("selectedAmount") || 0;

    function generateQRCode(amount) {
        selectedAmount = amount;
        localStorage.setItem("selectedAmount", amount);
        const qr = qrcode(0, 'L');
        qr.addData(`upi://pay?pa=herobhadra@okicici&pn=zeBRO&am=${amount}`);
        qr.make();
        document.getElementById("qrcode").innerHTML = qr.createImgTag();
        document.getElementById("qr-code-container").style.display = "block";
        document.getElementById("payment-proof-form").style.display = "block";
    }

    function submitPaymentProof() {
        const token = localStorage.getItem("token");
        const codetantraId = document.getElementById("codetantra-id").value.trim();
        const codetantraPassword = document.getElementById("codetantra-password").value.trim();
        const paymentId = document.getElementById("payment-id").value.trim();
        const fileInput = document.getElementById("screenshot");

        if (!codetantraId || !codetantraPassword || !paymentId || !fileInput.files.length) {
            alert("Please fill all fields before submitting.");
            return;
        }

        const formData = new FormData();
        formData.append("codetantraId", codetantraId);
        formData.append("codetantraPassword", codetantraPassword);
        formData.append("paymentId", paymentId);
        formData.append("amount", selectedAmount);
        formData.append("screenshot", fileInput.files[0]);

        fetch(`${backendUrl}/submit-payment`, {
            method: "POST",
            headers: { "Authorization": `Bearer ${token}` },
            body: formData
        })
        .then(res => res.json())
        .then(data => {
            alert(data.msg);
            fetchPayments();
        })
        .catch(() => alert("Error submitting proof."));
    }

    function fetchPayments() {
        const token = localStorage.getItem("token");
        fetch(`${backendUrl}/payment-status`, {
            headers: { "Authorization": `Bearer ${token}` }
        })
        .then(res => res.json())
        .then(data => {
            const paymentList = document.getElementById("payment-list");
            paymentList.innerHTML = "";
            data.payments.forEach(payment => {
                const div = document.createElement("div");
                div.innerHTML = `<p>Plan: ₹${payment.amount} | Status: ${payment.status}</p>`;
                paymentList.appendChild(div);
            });
        })
        .catch(() => alert("Error fetching payments."));
    }
</script>

</body>
</html>